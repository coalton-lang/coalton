name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        COALTON_ENV: ["release", "development"]
        SAFETY: ["0", "3"]

    permissions:
      packages: read

    container:
      image: ghcr.io/coalton-lang/sbcl-base
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        # Tell ASDF to look through our repo recursively
        # See https://github.com/actions/runner/issues/2058
        CL_SOURCE_REGISTRY: "/__w/coalton/coalton//"

    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        env:
          COALTON_ENV: ${{ matrix.COALTON_ENV }}
        run: |
          cat <<EOF > run-tests.lisp
          (sb-ext:restrict-compiler-policy 'safety ${{ matrix.SAFETY }})
          (defun main (&rest args)
            (declare (ignore args))
            (ql:quickload :coalton/tests)
            (asdf:test-system :coalton/tests)
            ; TODO: Remove this or add tests for these programs.
            (asdf:load-system :small-coalton-programs))
          EOF
          sbcl --noinform --non-interactive --load run-tests.lisp --eval "(main)"
